---
title: "workingdata"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
source("r-code/00_functions.R")
load("data/workingdata.RData")
using("plyr","ggplot2","tidyverse","purrr","dplyr","broom","knitr","skimr","MuMIn","ROCR","pscl","pROC","PerformanceAnalytics")

rm(.Random.seed, envir=globalenv())
set.seed(2020)
Nplants=3
```



# PreSelection of environmental variables
## Run all combinations of variables for all selected neophytes
```{r}
environment = env %>% dplyr::select(-plot_id,-date,-foliage)

# create separate datasets for each plant
plantsEnv = list()
for (i in 1:Nplants){
  plantsEnv[[i]] = as_tibble(cbind(plants[,i],environment))
  colnames(plantsEnv[[i]])[1] ="y"}


allfits=list()
for (i in 1:Nplants){
df =as.data.frame(plantsEnv[[i]])
#full <- glm(y~.+(1|site_id),data=df,family="binomial",na.action=na.fail)
set.seed(2020)
full <- glm(y~ring+traffic+activity+elevation+slope+plant_comunity+soil_coverage+soil_type+humus+cement+leak+waste+treeAbund+shrubAbund+herbAbund +aspect,data=df,family="binomial",na.action=na.fail)
allfits[[i]] <- MuMIn::dredge(full,m.lim=c(4,4))
#allfits[[i]] <- MuMIn::dredge(full,m.lim=c(3,3),trace = TRUE)
} # N parameter for each model
```




# Best AUC models
Get only models for selected neophytes above AUC threshold

```{r}
bestAUCmodels = list()
AUCthreshold = 0.80

for (i in 1:Nplants){
set.seed(2020)
df =as.data.frame(plantsEnv[[i]])
modelFits = allfits[[i]]
dredge.mdl <- get.models(modelFits,subset=T) # fct from MuMIn

aucsList=lapply(dredge.mdl,function(x)(do_auc(x, df))) # do_auc defined in 00_functions.R
aucs=unlist(aucsList)

#aucs[which.max(aucs)]
#names(dredge.mdl[[as.vector(which.max(aucs))]]$model)[-1]
print(length(which(aucs>AUCthreshold)))

bestAUC = as.vector(which(aucs>AUCthreshold))
l = lapply(bestAUC,function(x) names(dredge.mdl[[x]]$model)[-1])
bestAUCmodels[[i]]= data.frame(matrix(unlist(l), nrow=length(l), byrow=T),as.vector(aucs[which(aucs>AUCthreshold)]))
}
```



# most used combination
```{r}
result= plyr::ldply(bestAUCmodels, data.frame)
colnames(result)[ncol(result)]="AUC"

# combinations of 3 parameter for each model
resultFreq = result %>% dplyr::group_by(X1,X2,X3) %>% dplyr::summarise(n = n(),minAUC = min(AUC),maxAUC = max(AUC))
print(as_tibble(resultFreq %>% arrange(desc(n),desc(minAUC))),n=10)
resultFreq3 = resultFreq; result3 = result

# combinations of 4 parameter for each model
resultFreq = result %>% dplyr::group_by(X1,X2,X3,X4) %>% dplyr::summarise(n = n(),minAUC = min(AUC),maxAUC = max(AUC))
print(as_tibble(resultFreq %>% arrange(desc(n),desc(minAUC))),n=10)
resultFreq4 = resultFreq; result4 = result
```

> print(as_tibble(resultFreq %>% arrange(desc(n),desc(minAUC))),n=10)
# A tibble: 415 x 6
   X1       X2        X3            n minAUC maxAUC
   <chr>    <chr>     <chr>     <int>  <dbl>  <dbl>
 1 activity aspect    herbAbund    44  0.813  0.938
 2 activity cement    herbAbund    44  0.810  0.930
 3 activity elevation herbAbund    44  0.810  0.929
 4 activity aspect    cement       44  0.804  0.913
 5 activity herbAbund humus        40  0.838  0.941
 6 activity aspect    elevation    39  0.805  0.906
 7 activity cement    elevation    39  0.801  0.911
 8 activity cement    humus        39  0.801  0.932
 9 activity herbAbund leak         36  0.810  0.934
10 activity elevation humus        35  0.808  0.923
# â€¦ with 405 more rows


> print(as_tibble(resultFreq %>% arrange(desc(n),desc(minAUC))),n=10)
# A tibble: 1,333 x 7
   X1        X2             X3         X4            n minAUC maxAUC
   <chr>     <chr>          <chr>      <chr>     <int>  <dbl>  <dbl>
 1 herbAbund ring           slope      traffic       4  0.881  0.938
 2 activity  herbAbund      ring       slope         4  0.875  0.926
 3 herbAbund humus          slope      traffic       4  0.873  0.943
 4 herbAbund ring           traffic    treeAbund     4  0.872  0.941
 5 activity  herbAbund      shrubAbund treeAbund     4  0.869  0.928
 6 herbAbund shrubAbund     traffic    treeAbund     4  0.869  0.943
 7 cement    herbAbund      traffic    treeAbund     4  0.867  0.942
 8 activity  herbAbund      shrubAbund soil_type     4  0.866  0.911
 9 activity  herbAbund      shrubAbund traffic       4  0.865  0.927
10 activity  plant_comunity shrubAbund soil_type     4  0.865  0.923



```{r}
save(
  resultFreq3,result3,
  resultFreq4,result4,
    file="data/preselectionVariables.RData"
)
```





###### Binary environment
```{r}
dat = env %>% dplyr::select(traffic,plant_comunity,soil_type,humus,treeAbund,herbAbund,shrubAbund) # colSums(is.na(df))
datBinNum = env %>% dplyr::select(site_id,ring,activity,elevation,slope,cement,leak,waste,aspect)
# One-Hot Encoding
# Creating dummy variables is converting a categorical variable to as many binary variables as here are categories.
dummies_model <- caret::dummyVars( ~ ., data=dat)

# Create the dummy variables using predict. The Y variable (Purchase) will not be present in trainData_mat.
environment <- data.frame(predict(dummies_model, newdata = dat),datBinNum)

```


# PreSelection of environmental variables
## Run all combinations of variables for all selected neophytes
```{r}
preds = environment %>% dplyr::select(-treeAbund.0,-treeAbund.1,-treeAbund.2,-treeAbund.3,-herbAbund.0,-herbAbund.1,-herbAbund.2,-herbAbund.3,-shrubAbund.0,-shrubAbund.1,-shrubAbund.2,-shrubAbund.3)

# create separate datasets for each plant
plantsEnv = list()
for (i in 1:Nplants){
  plantsEnv[[i]] = as_tibble(cbind(plants[,i],preds))
  colnames(plantsEnv[[i]])[1] ="y"}


allfits=list()
for (i in 1:Nplants){
df =as.data.frame(plantsEnv[[i]])
#full <- glm(y~.+(1|site_id),data=df,family="binomial",na.action=na.fail)
set.seed(2020)
full <- glm(y~
ring+plant_comunity.altered.forest+plant_comunity.forest        
+plant_comunity.pasture+plant_comunity.shrubs+traffic.0+traffic.1+traffic.2+traffic.3+soil_type.1+soil_type.2+soil_type.3                  
+soil_type.4+humus.absent+humus.abundant+humus.rare+humus.regular                
+treeAbund.4+herbAbund.4+shrubAbund.4+activity+elevation+slope+cement+leak                         
+waste +aspect,data=df,family="binomial",na.action=na.fail)
allfits[[i]] <- MuMIn::dredge(full,m.lim=c(4,4),fixed= ~ring+activity,extra=c("R^2", "adjR^2"))
#allfits[[i]] <- MuMIn::dredge(full,m.lim=c(3,3),fixed= ~ring+activity,extra=c("R^2", "adjR^2"))
} # N parameter for each model
```






# Best AUC models - 4 parameters
Get only models for selected neophytes above AUC threshold

```{r}
modelsAUC = list()

for (i in 1:Nplants){
set.seed(2020)
df =as.data.frame(plantsEnv[[i]])
modelFits = allfits[[i]]
dredge.mdl <- get.models(modelFits, TRUE) # fct from MuMIn

aucsList=lapply(dredge.mdl,function(x)(do_auc(x, df))) # do_auc defined in 00_functions.R
AUC=unlist(aucsList)

l=lapply(1:length(dredge.mdl),function(x) names(dredge.mdl[[x]]$model)[-1])

modelsAUC[[i]]= data.frame(y=rep(i,length(l)),matrix(unlist(l), nrow=length(l), byrow=T),data.frame(modelFits)[,(ncol(modelFits)-6):ncol(modelFits)],AUC)
}



result= plyr::ldply(modelsAUC, data.frame)

# combinations of 4 parameter for each model
resultFreq = result %>% dplyr::group_by(X1,X2,X3,X4) %>% dplyr::summarise(n = n(),
                                                                          minR.2 = min(R.2),maxR.2 = max(R.2),meanAUC = mean(R.2),
                                                                          minAUC = min(AUC),maxAUC = max(AUC),meanAUC = mean(AUC))



resultFreq = data.frame(resultFreq)

# dat=data.frame(apply(resultFreq[,1:2],2,function(x) stringr::str_extract(x, "^.{5}")))
# dat$ident=NULL
# dat[which(dat[,1]==dat[,2]),"ident"]=1
# 
# resultFreq.filtered = resultFreq[-which(dat$ident==1),]
# 
# print(as_tibble(resultFreq.filtered) %>% arrange(desc(n), desc(minR.2)),n=10)
# print(as_tibble(resultFreq.filtered) %>% arrange(desc(n), desc(meanAUC)),n=10)
# 
# test = resultFreq.filtered %>% dplyr::filter(X1=="plant_comunity.altered.forest" | X2=="plant_comunity.altered.forest")

resultFreq4 = resultFreq; result4 = result
print(as_tibble(resultFreq %>% arrange(desc(n),desc(meanAUC))),n=100)
```

print(as_tibble(resultFreq %>% arrange(desc(n),desc(meanAUC))),n=100)
# A tibble: 300 x 10
    X1                            X2                            X3       X4        n minR.2 maxR.2 meanAUC minAUC maxAUC
    <chr>                         <chr>                         <chr>    <chr> <int>  <dbl>  <dbl>   <dbl>  <dbl>  <dbl>
  1 slope                         traffic.3                     activity ring      3  0.177  0.490   0.880  0.829  0.918
  2 humus.regular                 traffic.3                     activity ring      3  0.171  0.487   0.878  0.831  0.916
  3 herbAbund.4                   slope                         activity ring      3  0.188  0.420   0.875  0.866  0.883
  4 herbAbund.4                   traffic.3                     activity ring      3  0.176  0.481   0.875  0.835  0.904
  5 humus.regular                 slope                         activity ring      3  0.169  0.430   0.874  0.843  0.892
  6 traffic.3                     waste                         activity ring      3  0.168  0.475   0.874  0.837  0.903
  7 humus.absent                  traffic.3                     activity ring      3  0.165  0.483   0.874  0.824  0.912
  8 shrubAbund.4                  traffic.3                     activity ring      3  0.166  0.476   0.874  0.827  0.904
  9 soil_type.1                   traffic.3                     activity ring      3  0.164  0.507   0.873  0.822  0.925
 10 soil_type.3                   traffic.3                     activity ring      3  0.163  0.482   0.873  0.819  0.908
 11 soil_type.2                   traffic.3                     activity ring      3  0.173  0.475   0.873  0.830  0.903
 12 plant_comunity.pasture        slope                         activity ring      3  0.164  0.434   0.871  0.842  0.891
 13 slope                         soil_type.2                   activity ring      3  0.158  0.413   0.870  0.835  0.895
 14 plant_comunity.pasture        traffic.3                     activity ring      3  0.166  0.480   0.870  0.819  0.908
 15 humus.regular                 soil_type.2                   activity ring      3  0.166  0.414   0.869  0.834  0.891
 16 soil_type.4                   traffic.3                     activity ring      3  0.183  0.481   0.869  0.826  0.905
 17 slope                         traffic.2                     activity ring      3  0.151  0.448   0.869  0.821  0.906
 18 slope                         soil_type.3                   activity ring      3  0.148  0.424   0.868  0.822  0.895
 19 plant_comunity.shrubs         traffic.3                     activity ring      3  0.164  0.475   0.868  0.829  0.902
 20 leak                          slope                         activity ring      3  0.149  0.437   0.867  0.829  0.893


# A tibble: 300 x 10
    X1                            X2                            X3       X4        n minR.2 maxR.2 meanAUC minAUC maxAUC
    <chr>                         <chr>                         <chr>    <chr> <int>  <dbl>  <dbl>   <dbl>  <dbl>  <dbl>
  1 herbAbund.4                   slope                         activity ring      3  0.188  0.420   0.875  0.866  0.883
  2 humus.regular                 slope                         activity ring      3  0.169  0.430   0.874  0.843  0.892
  3 plant_comunity.pasture        slope                         activity ring      3  0.164  0.434   0.871  0.842  0.891
  4 plant_comunity.pasture        soil_type.2                   activity ring      3  0.160  0.422   0.862  0.838  0.875
  5 traffic.3                     waste                         activity ring      3  0.168  0.475   0.874  0.837  0.903
  6 herbAbund.4                   waste                         activity ring      3  0.159  0.408   0.858  0.836  0.871
  7 herbAbund.4                   traffic.3                     activity ring      3  0.176  0.481   0.875  0.835  0.904
  8 slope                         soil_type.2                   activity ring      3  0.158  0.413   0.870  0.835  0.895
  9 plant_comunity.pasture        waste                         activity ring      3  0.156  0.425   0.860  0.834  0.880
 10 humus.regular                 soil_type.2                   activity ring      3  0.166  0.414   0.869  0.834  0.891
 11 slope                         soil_type.4                   activity ring      3  0.163  0.414   0.864  0.833  0.881
 12 herbAbund.4                   soil_type.2                   activity ring      3  0.163  0.406   0.859  0.832  0.881
 13 humus.rare                    slope                         activity ring      3  0.148  0.422   0.866  0.832  0.888
 14 slope                         waste                         activity ring      3  0.150  0.412   0.866  0.832  0.884
 15 herbAbund.4                   soil_type.4                   activity ring      3  0.171  0.408   0.856  0.831  0.873
 16 humus.regular                 traffic.3                     activity ring      3  0.171  0.487   0.878  0.831  0.916
 17 humus.regular                 soil_type.4                   activity ring      3  0.169  0.416   0.862  0.830  0.879
 18 soil_type.2                   traffic.3                     activity ring      3  0.173  0.475   0.873  0.830  0.903
 19 leak                          slope                         activity ring      3  0.149  0.437   0.867  0.829  0.893
 20 herbAbund.4                   soil_type.3                   activity ring      3  0.151  0.417   0.864  0.829  0.883




# most used combination
```{r}
set.seed(2020)
df = as_tibble(cbind(plants,preds))
Cyn.dac.glmer = glmer(Cyn.dac~ring+activity+slope+herbAbund.4+(1|site_id),data=df,family=binomial(logit),control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun=2e5))); summary(Cyn.dac.glmer)
Meg.max.glmer = glmer(Meg.max~ring+activity+slope+herbAbund.4+(1|site_id),data=df,family=binomial(logit),control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun=2e5)));summary(Meg.max.glmer)
Ric.com.glmer = glmer(Ric.com~ring+activity+slope+herbAbund.4+(1|site_id),data=df,family=binomial(logit),control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun=2e5)));summary(Ric.com.glmer)
```


```{r}
save(Cyn.dac.glmer,Meg.max.glmer,Ric.com.glmer,file="data/individualSDM.RData")
```

