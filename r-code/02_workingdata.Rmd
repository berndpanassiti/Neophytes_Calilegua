---
title: "workingdata"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
source("r-code/00_functions.R")
load("data/rawdata.RData")
using("magrittr","dplyr","labdsv", "simba","tidyr","vegan","BiodiversityR","hablar","caret") 
# simba: #bb2num
# hablar:retype(), simplyfiing object into the following classes: date, numeric and character
# labdsv: matrify
```



# aspect value
http://ecology.msu.montana.edu/labdsv/R/labs/lab2/lab2.html

```{r}
sites$aspect=(cos((sites$exposure-30)/180*pi)+1)/2
sites$aspect[which(is.na(sites$aspect))]= 0.5 # neither hot or cold
```


# abbreviate vegetation names
```{r}
library(fuzzySim)
neophytes$plants <- fuzzySim::spCodes(neophytes$species, sep.species = " ", 
nchar.gen = 3, nchar.sp = 3, nchar.ssp = 0, sep.spcode = ".")

#sapply(taxonomy$species,nchar) # number of chars for entires name
taxonomy$plants<- fuzzySim::spCodes(taxonomy$species, sep.species = " ", 
nchar.gen = 1, nchar.sp = 20, nchar.ssp = 0, sep.spcode = ".")
```



Reshape species matrix and convert to percent

```{r}
# https://stackoverflow.com/questions/50691393/transform-community-data-into-wide-format-for-vegan-package
#df = species %>% select(plot_id,species,cover)
#dat.bb = matrify(as.matrix(df))

df = neophytes %>% dplyr::select(site_id,ring,plot_id,plants,cover)
#dat.bb = df %>% reshape2::dcast(df, site_id+ring+plot_id~species,value.var="count")
#dat.bb = df %>% reshape2::dcast(df, site_id+ring+plot_id~species,value.var="count")
dat.bb = df %>% tidyr::spread(key=plants,value=cover)

dat.bb= dat.bb %>% dplyr::mutate_at(c(4:17), ~replace(., is.na(.), 0)) # NO factors before!

neophytesPlotPercent=dat.bb
neophytesPlotPercent[,4:17]= bb2num(neophytesPlotPercent[,4:17], from = c("*", "1", "2", "3", "4", "5"), to = c(0.5, 2.5, 15, 37.5, 62.5, 87.5))
```


# Creation of full dataset: veg
veg dataset incudes also plots with no neophytes
```{r}
# 1 check if all plots of neophytes are present in sites
#neophytes[which(!neophytes$plot_id %in% sites$plot_id),]

# 2 Generate 0 for all plots with no neofites records
sites[which(!sites$plot_id %in% neophytes$plot_id),]

siteNoNeophytes = sites[which(!sites$plot_id %in% neophytesPlotPercent$plot_id),1:3]
NoNeophytes= neophytesPlotPercent[1:nrow(siteNoNeophytes),-c(1:3)]
NoNeophytes[NoNeophytes>0]=0
df= data.frame(cbind(siteNoNeophytes,NoNeophytes))
colnames(df)=colnames(neophytesPlotPercent)
veg=rbind(neophytesPlotPercent,df)


# scale continous environmental variables
env=sites %>% dplyr::select(-exposure)
env %<>% hablar::retype() 
cols=c("ring","zone","activity","plant_comunity","soil_coverage","soil_type","foliage","humus","cement","leak","waste","treeAbund","shrubAbund","herbAbund")
env %<>% dplyr::mutate_each_(funs(factor(.)),cols)


env[,-1] = env[,-1] %>% dplyr::mutate_if(is.numeric, function(x, na.rm = FALSE) as.numeric(scale(x)))
```




## Presences per site
```{r}
s=neophytesPlotPercent[,4:17]
s[s>0]=1 # function sign
plants=as_tibble(cbind(neophytesPlotPercent[,1],s))
vegSite=plants %>% dplyr::group_by(site_id) %>% summarise_all("max")
```




# preparation of datasets for statistical analyses: presence of 6 neophytes (<5%) + species richness (total number)
- presence/absence of neophytes
- total number of neophytes




```{r}
s=veg[,4:ncol(veg)]
s[s>0]=1 # function sign
NtotalNeophytes=apply(s,1,sum) # total number of all neophytes



s=vegan::specnumber(t(veg[,4:17]))
# > s
#          Arundo donax      Cynodon dactylon          Cyperus iria       Eleusine indica       Euphorbia hirta    Leonurus japonicus 
#                     3                    18                     9                     9                    14                     1 
# Leucaena leucocephala   Megathyrsus maximus       Melilotus albus       Psidium guajava      Ricinus communis         Sonchus asper 
#                     1                    78                     2                     1                    18                     2 
#    Sorghum halepensis  Tithonia tubaeformis 
#                     3                     1 

df=round(s/nrow(veg)*100,2)
df
#          Arundo donax      Cynodon dactylon          Cyperus iria       Eleusine indica       Euphorbia hirta    Leonurus japonicus 
#                  2.10                 12.59                  6.29                  6.29                  9.79                  0.70 
# Leucaena leucocephala   Megathyrsus maximus       Melilotus albus       Psidium guajava      Ricinus communis         Sonchus asper 
#                  0.70                 54.55                  1.40                  0.70                 12.59                  1.40 
#    Sorghum halepensis  Tithonia tubaeformis 
#                  2.10                  0.70 

df[df>9]
Cyn.dac Eup.hir Meg.max Ric.com 
  12.59    9.79   54.55   12.59

selectedNeophytes =veg %>% dplyr::select(site_id,ring,plot_id,names(df[df>9]))


# presences and total richness for selected neophytes
s=selectedNeophytes[,4:ncol(selectedNeophytes)]
s[s>0]=1 # function sign
NfreqNeophytes=apply(s,1,sum) # total number of selected neophytes


plants = as_tibble(cbind(s,NfreqNeophytes,NtotalNeophytes))
```




```{r}
save(
  neophytes,neophytesPlotPercent,
  sites,taxonomy,
  veg,env,vegEnv,vegSite,
  plants,
  file="data/workingdata.RData"
)
```

